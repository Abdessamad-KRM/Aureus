rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // Helper Functions
    // ============================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user is the owner of the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ============================================
    // Users Collection
    // ============================================

    match /users/{userId} {
      // Users can read their own data
      allow read: if isOwner(userId);

      // Users can write their own data with validation
      allow write: if isOwner(userId);

      // ✅ SÉCURITÉ (Phase 3): Validation que le PIN est hashé
      allow update: if isOwner(userId) &&
        // Si le champ pin est modifié, pinHashed doit être true
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['securityPin', 'pin']) ||
        request.resource.data.pinHashed == true);

      // User contacts sub-collection
      match /contacts/{contactId} {
        allow read, write: if isOwner(userId);
      }
    }

    // ============================================
    // Accounts Collection
    // ============================================

    match /accounts/{accountId} {
      // Users can read accounts belonging to them
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Only system can create accounts (done via Firebase Auth)
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;

      // Users can update their own accounts
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Prevent deletion of accounts
      allow delete: if false;
    }

    // ============================================
    // Cards Collection
    // ============================================

    match /cards/{cardId} {
      // Users can read cards belonging to them
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Users can create cards only if they own the associated account
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;

      // Users can update their own cards
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Users can delete their own cards
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================
    // Transactions Collection
    // ============================================

    match /transactions/{transactionId} {
      // Users can read their own transactions
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Users can create transactions for themselves
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;

      // Transactions are immutable once created
      allow update: if false;
      allow delete: if false;
    }

    // ============================================
    // Statistics Collection
    // ============================================

    match /statistics/{statisticId} {
      // Users can read their own statistics
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Statistics are read-only (generated, not user-created)
      allow create, update, delete: if false;
    }
  }
}